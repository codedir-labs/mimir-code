name: Security Checks

on:
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security checks weekly on Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read
  security-events: write

# Cancel in-progress runs when a new workflow with the same group name is triggered
concurrency:
  group: security-checks-workflow-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  clamav-scan:
    name: Malware Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install ClamAV
        run: |
          sudo apt-get update
          sudo apt-get install -y clamav clamav-daemon
          sudo freshclam

      - name: Scan repository
        run: |
          clamscan --recursive --infected --exclude-dir=node_modules --exclude-dir=.git . | tee scan.log
          INFECTED=$(grep -c "FOUND" scan.log || echo 0)
          echo "## ClamAV Scan Results" >> $GITHUB_STEP_SUMMARY
          if [ "$INFECTED" -gt 0 ]; then
            echo "::error::Malware detected!"
            exit 1
          fi
          echo "✅ No malware detected" >> $GITHUB_STEP_SUMMARY

  workflow-security:
    name: Workflow Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check for dangerous patterns
        run: |
          ISSUES=0
          echo "## Workflow Security Scan" >> $GITHUB_STEP_SUMMARY

          # Check for unpinned actions
          if grep -rE "uses: .+@(v[0-9]+|main|master|latest)" .github/workflows/*.yml; then
            echo "::error::Found unpinned actions (should use SHA)"
            ISSUES=$((ISSUES + 1))
          fi

          # Check for dangerous expression injections
          if grep -rE '\$\{\{.*github\.(event\.issue\.title|event\.pull_request\.title|event\.comment\.body)' .github/workflows/*.yml; then
            echo "::error::Potential expression injection vulnerability"
            ISSUES=$((ISSUES + 1))
          fi

          # Check for missing permissions
          for file in .github/workflows/*.yml; do
            if ! grep -q "permissions:" "$file"; then
              echo "::warning::$file is missing explicit permissions block"
            fi
          done

          if [ "$ISSUES" -gt 0 ]; then
            echo "❌ Found $ISSUES security issues" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ No security issues found in workflows" >> $GITHUB_STEP_SUMMARY
          fi

  npm-audit:
    name: NPM Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version: ${{ vars.NODE_VERSION || '22' }}
          cache: 'yarn'

      - name: Cache TypeScript build
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: |
            **/tsconfig.tsbuildinfo
            **/.tsbuildinfo
          key: tsc-${{ runner.os }}-${{ hashFiles('**/tsconfig.json') }}-${{ hashFiles('**/*.ts') }}

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run npm audit
        run: |
          yarn audit --level moderate || AUDIT_EXIT_CODE=$?

          if [ "${AUDIT_EXIT_CODE:-0}" -ge 16 ]; then
            echo "❌ npm audit failed with error"
            exit 1
          elif [ "${AUDIT_EXIT_CODE:-0}" -gt 0 ]; then
            echo "⚠️  Vulnerabilities found - review required"
            yarn audit --level moderate --json > audit-report.json || true
            exit 1
          else
            echo "✅ No vulnerabilities found"
          fi

      - name: Upload audit report
        if: failure()
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: npm-audit-report
          path: audit-report.json
          retention-days: 30

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Dependency Review
        uses: actions/dependency-review-action@3b139cfc5fae8b618d3eae3675e383bb1769c019 # v4.5.0
        with:
          fail-on-severity: moderate

  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Initialize CodeQL
        uses: github/codeql-action/init@6e93df3c1b954c609ccb2761345ddc9dba76b649 # v3.28.1
        with:
          languages: javascript-typescript
          queries: security-extended

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@6e93df3c1b954c609ccb2761345ddc9dba76b649 # v3.28.1
        with:
          category: '/language:javascript-typescript'

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call'

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan (PR)
        if: github.event_name == 'pull_request'
        uses: trufflesecurity/trufflehog@b6b00bbe5460109a21287b6612bd68a86bf060c2 # v3.88.3
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --only-verified

      - name: TruffleHog Secret Scan (Full Scan)
        if: github.event_name != 'pull_request'
        uses: trufflesecurity/trufflehog@b6b00bbe5460109a21287b6612bd68a86bf060c2 # v3.88.3
        with:
          path: ./
          extra_args: --only-verified

  sbom-generation:
    name: SBOM Generation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version: ${{ vars.NODE_VERSION || '22' }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Generate SBOM (CycloneDX)
        run: npx @cyclonedx/cyclonedx-npm --output-file sbom.json --output-format json

      - name: Upload SBOM
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: sbom
          path: sbom.json
          retention-days: 90

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version: ${{ vars.NODE_VERSION || '22' }}
          cache: 'yarn'

      - name: Cache npx tools
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: ~/.npm/_npx
          key: npx-tools-${{ runner.os }}-${{ hashFiles('.github/workflows/*.yml') }}

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Check licenses
        run: |
          npm install -g license-checker

          echo "## License Check Results" >> $GITHUB_STEP_SUMMARY

          # Check for forbidden licenses
          if license-checker --production --excludePrivatePackages --failOn "GPL;AGPL;LGPL" > /dev/null 2>&1; then
            echo "✅ No forbidden licenses found" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Forbidden licenses detected" >> $GITHUB_STEP_SUMMARY
            license-checker --production --excludePrivatePackages 2>&1 | head -50 >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### License Summary" >> $GITHUB_STEP_SUMMARY
          license-checker --summary --production --excludePrivatePackages >> $GITHUB_STEP_SUMMARY

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [clamav-scan, workflow-security, npm-audit, dependency-review, codeql-analysis, secret-scanning, sbom-generation, license-check]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "## Security Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ClamAV Scan | ${{ needs.clamav-scan.result == 'success' && '✅ Pass' || (needs.clamav-scan.result == 'skipped' && '⏭️ Skipped' || '❌ Fail') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Security | ${{ needs.workflow-security.result == 'success' && '✅ Pass' || (needs.workflow-security.result == 'skipped' && '⏭️ Skipped' || '❌ Fail') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| NPM Audit | ${{ needs.npm-audit.result == 'success' && '✅ Pass' || (needs.npm-audit.result == 'skipped' && '⏭️ Skipped' || '❌ Fail') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Review | ${{ needs.dependency-review.result == 'success' && '✅ Pass' || (needs.dependency-review.result == 'skipped' && '⏭️ Skipped' || '❌ Fail') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL | ${{ needs.codeql-analysis.result == 'success' && '✅ Pass' || (needs.codeql-analysis.result == 'skipped' && '⏭️ Skipped' || '❌ Fail') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scanning | ${{ needs.secret-scanning.result == 'success' && '✅ Pass' || (needs.secret-scanning.result == 'skipped' && '⏭️ Skipped' || '❌ Fail') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM Generation | ${{ needs.sbom-generation.result == 'success' && '✅ Pass' || (needs.sbom-generation.result == 'skipped' && '⏭️ Skipped' || '❌ Fail') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result == 'success' && '✅ Pass' || (needs.license-check.result == 'skipped' && '⏭️ Skipped' || '❌ Fail') }} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.clamav-scan.result }}" == "failure" ]] || \
             [[ "${{ needs.workflow-security.result }}" == "failure" ]] || \
             [[ "${{ needs.npm-audit.result }}" == "failure" ]] || \
             [[ "${{ needs.dependency-review.result }}" == "failure" ]] || \
             [[ "${{ needs.codeql-analysis.result }}" == "failure" ]] || \
             [[ "${{ needs.secret-scanning.result }}" == "failure" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ Security checks failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ All security checks passed" >> $GITHUB_STEP_SUMMARY
          fi
