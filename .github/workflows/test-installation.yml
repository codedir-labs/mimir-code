name: Test Installation Scripts

on:
  push:
    branches: [main, develop]
    paths:
      - 'scripts/install.sh'
      - 'scripts/install.ps1'
      - 'scripts/uninstall.sh'
      - 'scripts/uninstall.ps1'
      - '.github/workflows/test-installation.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'scripts/install.sh'
      - 'scripts/install.ps1'
      - 'scripts/uninstall.sh'
      - 'scripts/uninstall.ps1'
      - '.github/workflows/test-installation.yml'
  workflow_dispatch:

jobs:
  test-unix-installation:
    name: Test on ${{ matrix.os }} with Node ${{ matrix.node }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-20.04, ubuntu-22.04, ubuntu-latest, macos-13, macos-latest]
        node: ['18', '20', '22']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Make install script executable
        run: chmod +x scripts/install.sh

      - name: Test fresh installation
        run: |
          bash scripts/install.sh

          # Verify mimir command is available
          if command -v mimir &> /dev/null; then
            echo "✅ mimir command found in PATH"
          else
            echo "❌ mimir command not found"
            exit 1
          fi

          # Verify version
          mimir --version

          # Verify config directory was created
          if [ -d "$HOME/.mimir" ]; then
            echo "✅ .mimir directory created"
          else
            echo "❌ .mimir directory not found"
            exit 1
          fi

          # Verify config file exists
          if [ -f "$HOME/.mimir/config.yml" ]; then
            echo "✅ config.yml created"
          else
            echo "❌ config.yml not found"
            exit 1
          fi

      - name: Test configuration file content
        run: |
          # Check if config contains expected keys
          if grep -q "llm:" "$HOME/.mimir/config.yml"; then
            echo "✅ Config contains llm section"
          else
            echo "❌ Config missing llm section"
            exit 1
          fi

  test-windows-installation:
    name: Test on Windows with Node ${{ matrix.node }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        node: ['18', '20', '22']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Test PowerShell installation
        shell: pwsh
        run: |
          .\scripts\install.ps1

          # Verify mimir command
          try {
            $version = mimir --version
            Write-Host "✅ mimir installed: $version"
          } catch {
            Write-Host "❌ mimir command not found"
            exit 1
          }

          # Verify config directory
          if (Test-Path "$env:USERPROFILE\.mimir") {
            Write-Host "✅ .mimir directory created"
          } else {
            Write-Host "❌ .mimir directory not found"
            exit 1
          }

          # Verify config file
          if (Test-Path "$env:USERPROFILE\.mimir\config.yml") {
            Write-Host "✅ config.yml created"
          } else {
            Write-Host "❌ config.yml not found"
            exit 1
          }

  test-upgrade-scenario:
    name: Test Upgrade Scenario
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install version 0.1.0 (simulated)
        run: |
          chmod +x scripts/install.sh
          bash scripts/install.sh

          # Create a marker file to simulate v0.1.0
          echo "0.1.0" > ~/.mimir/.version

      - name: Modify config to test preservation
        run: |
          echo "# User custom config" >> ~/.mimir/config.yml
          echo "customSetting: true" >> ~/.mimir/config.yml

      - name: Run installation again (upgrade)
        run: |
          bash scripts/install.sh

          # Verify config was preserved
          if grep -q "customSetting" ~/.mimir/config.yml; then
            echo "✅ User config preserved during upgrade"
          else
            echo "❌ User config was overwritten"
            exit 1
          fi

  test-uninstall:
    name: Test Uninstall Script
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install mimir
        run: |
          chmod +x scripts/install.sh
          bash scripts/install.sh

      - name: Create uninstall script
        run: |
          cat > uninstall.sh << 'EOF'
          #!/usr/bin/env bash
          set -e

          echo "Uninstalling Mimir..."

          # Remove global npm package
          if command -v yarn &> /dev/null; then
            yarn global remove mimir-code || true
          else
            npm uninstall -g mimir-code || true
          fi

          # Ask user if they want to remove config
          echo ""
          echo "Remove configuration directory (~/.mimir)?"
          echo "This will delete all conversation history and settings."
          read -p "Remove config? (y/N): " -n 1 -r
          echo

          if [[ $REPLY =~ ^[Yy]$ ]]; then
            rm -rf ~/.mimir
            echo "✅ Configuration removed"
          else
            echo "⏭️  Configuration preserved"
          fi

          echo ""
          echo "✅ Mimir uninstalled successfully"
          EOF

          chmod +x scripts/uninstall.sh

      - name: Test uninstall (preserve config)
        run: |
          # Simulate user choosing to preserve config
          echo "N" | bash scripts/uninstall.sh || true

          # Config should still exist
          if [ -d "$HOME/.mimir" ]; then
            echo "✅ Config preserved as expected"
          else
            echo "❌ Config was removed unexpectedly"
            exit 1
          fi

      - name: Test uninstall (remove config)
        run: |
          # Simulate user choosing to remove config
          echo "Y" | bash scripts/uninstall.sh || true

          # Config should be gone
          if [ ! -d "$HOME/.mimir" ]; then
            echo "✅ Config removed as expected"
          else
            echo "❌ Config still exists"
            exit 1
          fi

  test-dependency-detection:
    name: Test Dependency Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test without Node.js
        run: |
          chmod +x scripts/install.sh

          # Remove Node.js from PATH temporarily
          export PATH=$(echo $PATH | sed 's|:/home/runner/.nvm/versions/node/[^:]*bin||g')

          # Script should detect missing Node.js and fail gracefully
          if bash scripts/install.sh 2>&1 | grep -q "Node.js.*required"; then
            echo "✅ Correctly detected missing Node.js"
          else
            echo "❌ Failed to detect missing Node.js"
            exit 1
          fi

  test-docker-detection:
    name: Test Docker Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Test with Docker available
        run: |
          chmod +x scripts/install.sh
          bash scripts/install.sh

          # Check if installation detected Docker
          if bash scripts/install.sh 2>&1 | grep -q "Docker"; then
            echo "✅ Docker detection working"
          fi

  test-shell-profile-update:
    name: Test Shell Profile Update
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create .bashrc if not exists
        run: touch ~/.bashrc

      - name: Run installation
        run: |
          chmod +x scripts/install.sh
          bash scripts/install.sh

      - name: Verify PATH was updated in .bashrc
        run: |
          if grep -q ".local/bin" ~/.bashrc || grep -q ".mimir" ~/.bashrc; then
            echo "✅ Shell profile updated"
          else
            echo "⚠️  Shell profile not updated (might already be in PATH)"
          fi
